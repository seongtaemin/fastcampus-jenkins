pipeline {
    agent any

    options {
        buildDiscarder logRotator(
            artifactDaysToKeepStr: '',
            artifactNumToKeepStr: '',
            daysToKeepStr: '5',
            numToKeepStr: '5'
        )
        githubProjectProperty(
            displayName: '',
            projectUrlStr: 'https://github.com/seongtaemin/fastcampus-jenkins'
        )
    }

    stages {
        stage('Prepare') {
            steps {
                sh "printenv"
                script {
                    properties([
                        pipelineTriggers([
                            [
                                $class        : 'GhprbTrigger',
                                adminlist     : 'seongtaemin',
                                cron          : "*/15 * * * *",
                                permitAll     : false,
                                useGitHubHooks: true,
                                triggerPhrase : '.*(test this|build this|deploy this).*',
                                gitHubAuthId  : 'ed41fbed-bd5b-48dc-bd22-ac30bb535b1e',
                                extensions    : [
                                    [
                                        $class             : 'GhprbSimpleStatus',
                                        commitStatusContext: 'jenkins',
                                        showMatrixStatus   : false
                                    ]
                                ]
                            ]
                        ])
                    ])
                }
            }
        }

        stage('Build') {
            steps {
                dir("projects/spring-app") {
                    withGradle {
                        sh "./gradlew build"
                    }
                }
            }
        }
    }

    post {
        always {
            scanForIssues tool: ktLint(pattern: '**/ktlint/**/*.xml')
            junit '**/test-results/**/*.xml'
            jacoco sourcePattern: '**/src/main/kotlin'
        }

        success {
            script {
                if ((env.ghprbCommentBody ?: "").contains("deploy this")) {
                    archiveArtifacts artifacts: 'projects/spring-app/build/libs/*-SNAPSHOT.jar'
                    build(
                        job: 'pipeline-deploy',
                        parameters: [
                            booleanParam(name: 'ARE_YOU_SURE', value: true)
                        ],
                        wait: false,
                        propagate: false
                    )
                }
            }
        }
    }
}
